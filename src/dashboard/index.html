<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS Command Center</title>
<link rel="icon" type="image/svg+xml" href="/dashboard/logo.svg">
<link rel="apple-touch-icon" href="/dashboard/logo.svg">
<meta name="description" content="NEXUS — Autonomous AI Engineering Organization Dashboard">
<meta property="og:title" content="NEXUS Command Center">
<meta property="og:description" content="Real-time orchestration dashboard for an autonomous AI engineering org">
<meta property="og:type" content="website">
<style>
  :root {
    --bg: #0a0a1a; --surface: #12122a; --border: #1e1e3a;
    --text: #e0e0f0; --dim: #8888aa; --accent: #00D2FF;
    --secondary: #7B61FF; --success: #00E676; --warning: #FFD740;
    --danger: #FF5252; --radius: 10px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'SF Mono', 'Fira Code', monospace; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Accessibility - Focus indicators */
  *:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      gap: 12px;
      padding: 16px 20px;
    }
    .grid {
      grid-template-columns: 1fr;
      padding: 16px 20px;
    }
    .card[style*="grid-column"] {
      grid-column: 1 !important;
    }
  }

  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 32px; border-bottom: 1px solid var(--border);
  }
  .header h1 { font-size: 24px; letter-spacing: 4px; color: var(--accent); }
  .header .status { display: flex; align-items: center; gap: 8px; }
  .header .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 16px; padding: 24px 32px; }

  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; transition: border-color 0.2s;
  }
  .card:hover { border-color: var(--accent); }
  .card-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; cursor: pointer; user-select: none;
    width: 100%; background: transparent; border: none; color: inherit; font: inherit;
    text-align: left;
  }
  .card-header:hover { background: rgba(255,255,255,0.02); }
  .card-header:active { background: rgba(255,255,255,0.04); }
  .card-header h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: var(--dim); }
  .card-summary { font-size: 28px; font-weight: bold; color: var(--accent); }
  .card-body { padding: 0 20px 16px; display: none; }
  .card.expanded .card-body { display: block; }
  .card-header .chevron { transition: transform 0.2s; color: var(--dim); }
  .card.expanded .card-header .chevron { transform: rotate(180deg); }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; color: var(--dim); padding: 8px 0; border-bottom: 1px solid var(--border); font-weight: normal; text-transform: uppercase; letter-spacing: 1px; font-size: 11px; }
  td { padding: 8px 0; border-bottom: 1px solid var(--border); }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;
  }
  .badge-ok { background: rgba(0,230,118,0.15); color: var(--success); }
  .badge-warn { background: rgba(255,215,64,0.15); color: var(--warning); }
  .badge-err { background: rgba(255,82,82,0.15); color: var(--danger); }
  .badge-idle { background: rgba(136,136,170,0.15); color: var(--dim); }

  .event-log { max-height: 300px; overflow-y: auto; font-size: 12px; }

  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border-width: 0;
  }
  .event-row { display: flex; gap: 12px; padding: 6px 0; border-bottom: 1px solid var(--border); }
  .event-time { color: var(--dim); flex-shrink: 0; width: 60px; }
  .event-source { color: var(--secondary); flex-shrink: 0; width: 100px; }

  .circuit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; }
  .circuit-chip {
    padding: 8px 12px; border-radius: 6px; text-align: center; font-size: 12px;
    border: 1px solid var(--border);
  }
  .circuit-closed { border-color: var(--success); color: var(--success); }
  .circuit-open { border-color: var(--danger); color: var(--danger); background: rgba(255,82,82,0.08); }
  .circuit-half_open { border-color: var(--warning); color: var(--warning); }

  .empty { color: var(--dim); font-style: italic; padding: 16px 0; text-align: center; }
  footer { text-align: center; padding: 24px; color: var(--dim); font-size: 12px; }

  /* Chat panel — slide-out from right */
  .chat-toggle {
    position: fixed; bottom: 24px; right: 24px; z-index: 100;
    width: 56px; height: 56px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--secondary));
    border: none; cursor: pointer; color: #fff; font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 20px rgba(0,210,255,0.3);
    transition: transform 0.2s;
  }
  .chat-toggle:hover { transform: scale(1.1); }

  .chat-panel {
    position: fixed; top: 0; right: -420px; width: 420px; height: 100vh;
    background: var(--surface); border-left: 1px solid var(--border);
    z-index: 200; transition: right 0.3s ease;
    display: flex; flex-direction: column;
  }
  .chat-panel.open { right: 0; }

  .chat-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
  }
  .chat-header h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }
  .chat-close { background: none; border: none; color: var(--dim); cursor: pointer; font-size: 20px; padding: 4px 8px; }
  .chat-close:hover { color: var(--text); }

  .chat-threads {
    padding: 8px 12px; border-bottom: 1px solid var(--border);
    max-height: 160px; overflow-y: auto;
  }
  .thread-item {
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
    font-size: 12px; color: var(--dim); margin-bottom: 4px;
    border: 1px solid transparent; background: none; width: 100%;
    text-align: left; font-family: inherit;
  }
  .thread-item:hover { background: rgba(255,255,255,0.03); border-color: var(--border); }
  .thread-item.active { border-color: var(--accent); color: var(--text); }
  .thread-count { color: var(--secondary); font-size: 11px; }

  .chat-messages {
    flex: 1; overflow-y: auto; padding: 16px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .msg { max-width: 85%; padding: 10px 14px; border-radius: 10px; font-size: 13px; line-height: 1.5; word-break: break-word; }
  .msg-user { align-self: flex-end; background: var(--accent); color: #0a0a1a; border-bottom-right-radius: 2px; }
  .msg-bot { align-self: flex-start; background: var(--border); color: var(--text); border-bottom-left-radius: 2px; }
  .msg-searching { font-style: italic; color: var(--dim); font-size: 12px; align-self: center; }

  .chat-input-area {
    padding: 12px 16px; border-top: 1px solid var(--border);
    display: flex; gap: 8px;
  }
  .chat-input {
    flex: 1; padding: 10px 14px; border-radius: 8px;
    border: 1px solid var(--border); background: var(--bg);
    color: var(--text); font-family: inherit; font-size: 13px;
    resize: none; min-height: 40px; max-height: 120px;
  }
  .chat-input:focus { border-color: var(--accent); outline: none; }
  .chat-send {
    padding: 10px 16px; border-radius: 8px; border: none;
    background: var(--accent); color: #0a0a1a; cursor: pointer;
    font-family: inherit; font-weight: bold; font-size: 13px;
    align-self: flex-end;
  }
  .chat-send:hover { opacity: 0.9; }
  .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }

  @media (max-width: 768px) {
    .chat-panel { width: 100vw; right: -100vw; }
  }
</style>
</head>
<body>

<header class="header" role="banner">
  <h1>NEXUS</h1>
  <div class="status" role="status" aria-live="polite">
    <div class="dot" aria-hidden="true"></div>
    <span id="engine-status">Connecting...</span>
  </div>
</header>

<main class="grid" role="main">
  <div class="card" id="card-directive">
    <button class="card-header" aria-expanded="false" aria-controls="directive-detail">
      <div><h2>Active Directive</h2><div class="card-summary" id="directive-summary">--</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="directive-detail" role="region" aria-labelledby="directive-summary"></div>
  </div>

  <div class="card" id="card-agents">
    <button class="card-header" aria-expanded="false" aria-controls="agents-detail">
      <div><h2>Agents</h2><div class="card-summary" id="agents-summary">--</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="agents-detail" role="region" aria-labelledby="agents-summary"></div>
  </div>

  <div class="card" id="card-cost">
    <button class="card-header" aria-expanded="false" aria-controls="cost-detail">
      <div><h2>Cost</h2><div class="card-summary" id="cost-summary">--</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="cost-detail" role="region" aria-labelledby="cost-summary"></div>
  </div>

  <div class="card" id="card-health">
    <button class="card-header" aria-expanded="false" aria-controls="health-detail">
      <div><h2>Health</h2><div class="card-summary" id="health-summary">--</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="health-detail" role="region" aria-labelledby="health-summary"></div>
  </div>

  <div class="card" id="card-circuits">
    <button class="card-header" aria-expanded="false" aria-controls="circuits-detail">
      <div><h2>Circuit Breakers</h2><div class="card-summary" id="circuits-summary">--</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="circuits-detail" role="region" aria-labelledby="circuits-summary"></div>
  </div>

  <div class="card" id="card-escalations">
    <button class="card-header" aria-expanded="false" aria-controls="escalations-detail">
      <div><h2>Escalations</h2><div class="card-summary" id="escalations-summary">0</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="escalations-detail" role="region" aria-labelledby="escalations-summary"></div>
  </div>

  <div class="card expanded" id="card-events" style="grid-column: 1 / -1;">
    <button class="card-header" aria-expanded="true" aria-controls="event-log-container">
      <div><h2>Live Events</h2><div class="card-summary" id="events-summary">0</div></div>
      <span class="chevron" aria-hidden="true">&#9660;</span>
    </button>
    <div class="card-body" id="event-log-container" role="region" aria-labelledby="events-summary">
      <div class="event-log" id="event-log" aria-live="polite" aria-atomic="false"></div>
    </div>
  </div>
</main>

<footer role="contentinfo">NEXUS v3.0 &mdash; Autonomous AI Organization Platform</footer>

<!-- Chat toggle button -->
<button id="chat-toggle" class="chat-toggle" aria-label="Open chat">&#9993;</button>

<!-- Chat slide-out panel -->
<div id="chat-panel" class="chat-panel" role="complementary" aria-label="Chat">
  <div class="chat-header">
    <h2>Threads</h2>
    <button id="chat-close" class="chat-close" aria-label="Close chat">&times;</button>
  </div>
  <div id="thread-list" class="chat-threads"></div>
  <div id="chat-messages" class="chat-messages" aria-live="polite"></div>
  <div class="chat-input-area">
    <textarea id="chat-input" class="chat-input" placeholder="Send a message..." rows="1"></textarea>
    <button id="chat-send" class="chat-send">Send</button>
  </div>
</div>

<script>
const API = window.location.origin;
let eventCount = 0;
let currentSSE = null;
let abortController = null;

function toggle(event) {
  const button = event.currentTarget;
  const card = button.closest('.card');
  const isExpanded = card.classList.contains('expanded');

  card.classList.toggle('expanded');
  button.setAttribute('aria-expanded', !isExpanded);
}

function el(tag, attrs, children) {
  const e = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k, v]) => {
    if (k === 'class') e.className = v;
    else if (k === 'style') e.style.cssText = v;
    else e.setAttribute(k, v);
  });
  if (typeof children === 'string') e.textContent = children;
  else if (Array.isArray(children)) children.forEach(c => { if (c) e.appendChild(c); });
  return e;
}

function badge(text, type) {
  return el('span', {class: `badge badge-${type}`}, text);
}

function buildTable(headers, rows) {
  const table = el('table');
  const thead = el('tr', null, headers.map(h => el('th', null, h)));
  table.appendChild(thead);
  rows.forEach(cells => {
    const tr = el('tr', null, cells.map(c => {
      const td = el('td');
      if (c instanceof HTMLElement) td.appendChild(c);
      else td.textContent = String(c);
      return td;
    }));
    table.appendChild(tr);
  });
  return table;
}

function clear(id) { document.getElementById(id).replaceChildren(); }

async function fetchJSON(path) {
  try {
    if (abortController) abortController.abort();
    abortController = new AbortController();
    return await (await fetch(API + path, { signal: abortController.signal })).json();
  }
  catch (err) {
    if (err.name !== 'AbortError') console.error('Fetch error:', err);
    return null;
  }
}

async function refreshState() {
  const [state, agents, directive, cost, health, metricsHealth] = await Promise.all([
    fetchJSON('/state'), fetchJSON('/agents'), fetchJSON('/directive'),
    fetchJSON('/cost'), fetchJSON('/health'), fetchJSON('/metrics/health'),
  ]);

  if (health) {
    const running = health.engine_running;
    document.getElementById('engine-status').textContent = running ? 'Engine Online' : 'Engine Offline';
    document.querySelector('.dot').style.background = running ? 'var(--success)' : 'var(--danger)';
    document.getElementById('health-summary').textContent = running ? 'OK' : 'DOWN';

    const rows = [
      ['Engine', running ? badge('Running', 'ok') : badge('Stopped', 'err')],
      ['Active Agents', String(health.working_agents || 0)],
      ['Total Agents', String(health.agents || 0)],
    ];
    if (health.resilience) {
      rows.push(['Uptime', Math.round(health.resilience.uptime_seconds || 0) + 's']);
      rows.push(['Health Checks', String(health.resilience.check_count || 0)]);
      rows.push(['Dead Letter Queue', String(health.resilience.dead_letter_depth || 0)]);
    }
    const container = document.getElementById('health-detail');
    container.replaceChildren(buildTable(['Metric', 'Value'], rows));
  }

  if (directive) {
    const d = directive.directive;
    const container = document.getElementById('directive-detail');
    if (d) {
      document.getElementById('directive-summary').textContent = d.status || 'active';
      const frag = document.createDocumentFragment();
      frag.appendChild(el('p', {style: 'margin-bottom:12px;color:var(--text)'}, d.text || '--'));
      if (directive.task_board && directive.task_board.length) {
        const rows = directive.task_board.map(t => {
          const st = t.status === 'completed' ? 'ok' : t.status === 'failed' ? 'err' : 'idle';
          return [(t.description||'').substring(0,60), badge(t.status, st), t.assigned_to||'--'];
        });
        frag.appendChild(buildTable(['Task', 'Status', 'Agent'], rows));
      }
      container.replaceChildren(frag);
    } else {
      document.getElementById('directive-summary').textContent = 'Idle';
      container.replaceChildren(el('div', {class: 'empty'}, 'No active directive'));
    }
  }

  if (agents) {
    const list = agents.agents || [];
    const working = list.filter(a => a.status === 'working' || a.status === 'thinking').length;
    document.getElementById('agents-summary').textContent = working + ' / ' + list.length;
    const rows = list.slice(0, 20).map(a => {
      const st = a.status === 'working' ? 'ok' : a.status === 'thinking' ? 'warn' : 'idle';
      return [a.name || a.agent_id, badge(a.status, st), (a.last_action||'--').substring(0,40)];
    });
    document.getElementById('agents-detail').replaceChildren(buildTable(['Agent', 'Status', 'Last Action'], rows));
  }

  if (cost) {
    const total = cost.total_cost_usd || cost.total || 0;
    const rate = cost.hourly_rate || 0;
    document.getElementById('cost-summary').textContent = '$' + total.toFixed(2);
    const rows = [['Total Spend', '$' + total.toFixed(2)], ['Hourly Rate', '$' + rate.toFixed(2) + '/hr']];
    if (cost.by_model) {
      Object.entries(cost.by_model).forEach(([m, c]) => rows.push([m, '$' + Number(c).toFixed(3)]));
    }
    document.getElementById('cost-detail').replaceChildren(buildTable(['Metric', 'Value'], rows));
  }

  if (metricsHealth) {
    const circuits = metricsHealth.circuits || [];
    const openCount = circuits.filter(c => c.state === 'open').length;
    document.getElementById('circuits-summary').textContent = openCount > 0 ? openCount + ' OPEN' : circuits.length > 0 ? circuits.length + ' OK' : '--';

    const circuitContainer = document.getElementById('circuits-detail');
    if (circuits.length) {
      const grid = el('div', {class: 'circuit-grid'});
      circuits.forEach(c => {
        const chip = el('div', {class: 'circuit-chip circuit-' + c.state});
        chip.appendChild(el('span', null, c.name));
        chip.appendChild(document.createElement('br'));
        chip.appendChild(el('small', null, c.state));
        grid.appendChild(chip);
      });
      circuitContainer.replaceChildren(grid);
    } else {
      circuitContainer.replaceChildren(el('div', {class: 'empty'}, 'No circuits registered'));
    }

    const esc = metricsHealth.escalation || {};
    document.getElementById('escalations-summary').textContent = String(esc.total_escalations || 0);
    const recent = esc.recent_escalations || [];
    const escContainer = document.getElementById('escalations-detail');
    if (recent.length) {
      const rows = recent.map(e => [e.id, e.agent, e.reason]);
      escContainer.replaceChildren(buildTable(['ID', 'Agent', 'Reason'], rows));
    } else {
      escContainer.replaceChildren(el('div', {class: 'empty'}, 'No escalations'));
    }
  }
}

function connectSSE() {
  if (currentSSE) {
    currentSSE.close();
    currentSSE = null;
  }

  const es = new EventSource(API + '/events?last_id=0');
  currentSSE = es;

  es.onmessage = (e) => {
    eventCount++;
    document.getElementById('events-summary').textContent = String(eventCount);
    try {
      const data = JSON.parse(e.data);
      const log = document.getElementById('event-log');
      const time = data.timestamp ? (data.timestamp.split('T')[1] || '').substring(0,8) : '';
      const row = el('div', {class: 'event-row'}, [
        el('span', {class: 'event-time'}, time),
        el('span', {class: 'event-source'}, data.source || '--'),
        el('span', null, data.type || '--'),
      ]);
      log.prepend(row);
      while (log.children.length > 100) log.removeChild(log.lastChild);
    } catch { /* ignore malformed events */ }
  };

  es.onerror = () => {
    if (currentSSE === es) {
      es.close();
      currentSSE = null;
      setTimeout(connectSSE, 5000);
    }
  };
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  if (currentSSE) currentSSE.close();
  if (abortController) abortController.abort();
});

// Attach event listeners to card headers
document.querySelectorAll('.card-header').forEach(header => {
  header.addEventListener('click', toggle);
  header.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggle(e);
    }
  });
});

refreshState();
setInterval(refreshState, 5000);
connectSSE();

// ---------------------------------------------------------------------------
// Chat Panel — view and interact with Slack threads
// ---------------------------------------------------------------------------

const chatToggle = document.getElementById('chat-toggle');
const chatPanel = document.getElementById('chat-panel');
const chatClose = document.getElementById('chat-close');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const threadList = document.getElementById('thread-list');

let activeThreadTs = null;

chatToggle.addEventListener('click', () => {
  chatPanel.classList.toggle('open');
  if (chatPanel.classList.contains('open')) loadThreads();
});
chatClose.addEventListener('click', () => chatPanel.classList.remove('open'));

async function loadThreads() {
  try {
    const resp = await fetch(`${API}/chat/threads`);
    const data = await resp.json();
    threadList.replaceChildren();
    if (!data.threads || data.threads.length === 0) {
      threadList.appendChild(el('div', {class: 'empty'}, 'No threads yet'));
      return;
    }
    for (const t of data.threads) {
      const btn = el('button', {
        class: 'thread-item' + (t.thread_ts === activeThreadTs ? ' active' : ''),
      });
      btn.appendChild(document.createTextNode(t.text.slice(0, 80) || '(empty)'));
      if (t.reply_count > 0) {
        btn.appendChild(el('span', {class: 'thread-count'}, ` (${t.reply_count})`));
      }
      btn.addEventListener('click', () => selectThread(t.thread_ts));
      threadList.appendChild(btn);
    }
  } catch { threadList.replaceChildren(el('div', {class: 'empty'}, 'Slack not connected')); }
}

async function selectThread(ts) {
  activeThreadTs = ts;
  document.querySelectorAll('.thread-item').forEach(b => b.classList.remove('active'));
  try {
    const resp = await fetch(`${API}/chat/thread/${ts}`);
    const data = await resp.json();
    chatMessages.replaceChildren();
    for (const msg of data.messages || []) {
      const cls = msg.is_bot ? 'msg msg-bot' : 'msg msg-user';
      chatMessages.appendChild(el('div', {class: cls}, msg.text));
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch { chatMessages.replaceChildren(el('div', {class: 'empty'}, 'Failed to load thread')); }
}

chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  chatInput.value = '';
  chatSend.disabled = true;
  chatMessages.appendChild(el('div', {class: 'msg msg-user'}, text));
  chatMessages.appendChild(el('div', {class: 'msg-searching'}, 'Thinking...'));
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    const resp = await fetch(`${API}/chat/send`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: text}),
    });
    const data = await resp.json();
    // Remove "Thinking..." indicator
    const thinking = chatMessages.querySelector('.msg-searching');
    if (thinking) thinking.remove();
    chatMessages.appendChild(el('div', {class: 'msg msg-bot'}, data.response || '(no response)'));
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (err) {
    const thinking = chatMessages.querySelector('.msg-searching');
    if (thinking) thinking.remove();
    chatMessages.appendChild(el('div', {class: 'msg msg-bot'}, 'Error: ' + err.message));
  } finally {
    chatSend.disabled = false;
    chatInput.focus();
  }
}
</script>
</body>
</html>
